{% extends 'base.html' %}
{% block content %}

<div class="container mx-auto px-4 py-8" style="margin-top: 80px;">
  <h2 class="text-3xl font-bold mb-8 text-gray-800 flex items-center gap-2">
    {% if category %}
      <i class="fas fa-folder-open text-blue-600"></i> {{ category.name }}
    {% else %}
      <i class="fas fa-boxes text-blue-600"></i> All Programs
    {% endif %}
  </h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for program in programs.items %}
    {% set annual_budget = program.annual_budget|float %}
    {% set total_donated = program.total_donated|float %}
    {% set donated_percent = (total_donated / annual_budget * 100) if annual_budget > 0 else 0 %}
    {% set remaining_percent = 100 - donated_percent %}

    <div class="bg-white rounded-xl shadow-md overflow-hidden relative flex flex-col">
      <div class="absolute top-3 left-3 bg-blue-600 text-white text-sm px-3 py-1 rounded-full z-10">
        {{ program.category.name }}
      </div>

      <div class="aspect-video overflow-hidden">
        {% set img = program.images.first() %}
        <img src="{{ img|program_image_url }}" alt="{{ program.title }}"
             class="object-cover w-full h-full transition-transform duration-300 hover:scale-105">
      </div>

      <div class="p-5 flex-grow flex flex-col justify-between">
        <div>
          <h3 class="text-xl font-semibold text-gray-800 mb-2">{{ program.title }}</h3>

          <!-- Progress Bar -->
          <div x-data="{ donated: {{ donated_percent|round(1) }} }" class="w-full bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
            <div class="bg-green-500 h-full transition-all duration-500 ease-out" :style="`width: ${donated}%`"></div>
          </div>

          <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Goal: <strong>KES{{ "{:,.0f}".format(annual_budget) }}</strong></span>
            <span>Raised: <strong class="text-green-600">KES{{ "{:,.0f}".format(total_donated) }}</strong></span>
          </div>
          <div class="text-sm text-blue-600 mb-2">
            Remaining: KES{{ "{:,.0f}".format(annual_budget - total_donated) }}
          </div>

          <p class="text-gray-600 text-sm mb-3">{{ program.description|truncate(180) }}</p>
        </div>

        <div class="mt-auto flex items-center justify-between pt-4 border-t">
          <div class="text-sm text-gray-500">
            <div>Started on {{ program.created_at.strftime('%b %d, %Y') }}</div>
            <div>by {{ program.author.username }}</div>
          </div>

          <a href="{{ url_for('main.program_detail', slug=program.slug) }}"
             class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
            View Details <i class="fas fa-arrow-right"></i>
          </a>
        </div>
      </div>

      <a href="{{ url_for('donate.donate', program_id=program.id) }}"
         class="absolute top-3 right-3 bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded-full shadow">
        <i class="fas fa-donate mr-1"></i> Donate
      </a>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="mt-10 flex justify-center">
    <nav class="inline-flex shadow-sm rounded-md overflow-hidden" aria-label="Pagination">
      {% if programs.has_prev %}
        <a href="{% if category %}{{ url_for('main.programs_by_category', category_slug=category.slug, page=programs.prev_num) }}{% else %}{{ url_for('main.all_programs', page=programs.prev_num) }}{% endif %}"
           class="px-4 py-2 bg-white text-sm text-gray-600 hover:bg-gray-100 border border-gray-300">
          &laquo; Previous
        </a>
      {% else %}
        <span class="px-4 py-2 bg-gray-100 text-sm text-gray-400 border border-gray-300">&laquo; Previous</span>
      {% endif %}

      {% for page_num in programs.iter_pages() %}
        <a href="{% if category %}{{ url_for('main.programs_by_category', category_slug=category.slug, page=page_num) }}{% else %}{{ url_for('main.all_programs', page=page_num) }}{% endif %}"
           class="px-3 py-2 text-sm border border-gray-300 
                  {% if page_num == programs.page %} bg-blue-600 text-white {% else %} bg-white text-gray-700 hover:bg-gray-100 {% endif %}">
          {{ page_num }}
        </a>
      {% endfor %}

      {% if programs.has_next %}
        <a href="{% if category %}{{ url_for('main.programs_by_category', category_slug=category.slug, page=programs.next_num) }}{% else %}{{ url_for('main.all_programs', page=programs.next_num) }}{% endif %}"
           class="px-4 py-2 bg-white text-sm text-gray-600 hover:bg-gray-100 border border-gray-300">
          Next &raquo;
        </a>
      {% else %}
        <span class="px-4 py-2 bg-gray-100 text-sm text-gray-400 border border-gray-300">Next &raquo;</span>
      {% endif %}
    </nav>
  </div>
</div>



{% endblock %}